# Gospel Language Study - Project Guide

## Overview

Local-first language learning app using LDS General Conference talks with synchronized multi-lingual audio and text. User speaks English and Mandarin fluently, learning Czech, Spanish, Russian.

## Architecture

**Monorepo** with three-layer backend and SvelteKit frontend:

```
gospel-language-study/
├── backend/           # Python FastAPI
│   └── src/gls/
│       ├── api/       # HTTP layer (thin)
│       ├── domain/    # Business logic, models, protocols
│       ├── infrastructure/  # Storage, AI providers
│       └── schemas/   # Pydantic request/response
├── frontend/          # SvelteKit + Svelte 5
│   └── src/
│       ├── lib/       # API client, components, stores
│       └── routes/    # Pages
└── data/              # Talk files (gitignored content)
    └── talks/{talk_id}/{lang}/  # audio.mp3, text.txt, alignment.json
```

## Tech Stack

- **Backend**: Python 3.9+ / FastAPI / SQLite (future) / Pydantic
- **Frontend**: SvelteKit 2 / Svelte 5 / TypeScript
- **AI**: OpenAI/Anthropic APIs (abstracted via protocols for DI)
- **Audio Alignment**: WhisperX for word-level timestamps
- **Quality**: ruff, mypy, pytest / eslint, prettier, svelte-check

## Key Design Decisions

1. **Protocol-based DI**: `domain/protocols.py` defines abstract interfaces for repositories
2. **File-based storage for MVP**: Talks read from filesystem, alignment as JSON
3. **3-letter ISO 639-2 language codes**: `eng`, `zhs`, `ces`, `spa`, `rus` (matches church site)
4. **Svelte 5 runes**: Using `$state`, `$derived` for reactive state
5. **Graceful error handling**: All network/AI operations should handle failures with user feedback

## Running the Project

```bash
# Backend
cd backend
source .venv/bin/activate  # venv already created
uvicorn gls.main:app --reload --port 8000

# Frontend
cd frontend
npm run dev  # Port 5173, proxies /api to :8000
```

## Testing

```bash
# Backend
cd backend && source .venv/bin/activate
pytest -v                    # Tests
ruff check src tests         # Lint
mypy src --ignore-missing-imports  # Types

# Frontend
cd frontend
npm run check   # TypeScript/Svelte
npm run lint    # ESLint
```

## Data Format

Talks stored as:
```
data/talks/{talk_id}/
├── {lang}/
│   ├── *.mp3           # Audio file
│   ├── *.txt           # Text (pdftotext output OK, noise handled)
│   └── alignment.json  # Word-level timestamps (generated by WhisperX)
```

Alignment JSON structure:
```json
{
  "talk_id": "2025-10-58-oaks",
  "language": "eng",
  "segments": [{
    "segment_id": "seg-001",
    "text": "Brothers and sisters...",
    "start_time": 0.0,
    "end_time": 4.2,
    "words": [{"word": "Brothers", "start_time": 0.0, "end_time": 0.45, "confidence": 0.98}]
  }]
}
```

## Current State (Phase 2 Complete)

### Backend - Working
- `GET /health` - Health check
- `GET /api/v1/talks` - List talks (reads from data/talks/)
- `GET /api/v1/talks/{id}` - Get talk details
- `GET /api/v1/playback/audio/{talk_id}/{lang}` - Stream audio file
- `GET /api/v1/playback/text/{talk_id}/{lang}` - Get text content
- `GET /api/v1/playback/alignment/{talk_id}/{lang}` - Get word-level alignment
- Domain models: `Talk`, `TalkVersion`, `Alignment`, `VocabularyItem`
- File-based repositories: `FileTalkRepository`, `FileAlignmentRepository`

### Frontend - Working
- Home page lists talks from API
- **Study view** at `/talks/[talkId]` with:
  - Language selection (audio/text independently)
  - AudioPlayer with play/pause, speed control (0.5x-2x), progress bar
  - SyncedText with segment/word highlighting during playback
  - Click-to-seek on words (when alignment available)
- **PlaybackStore** with Svelte 5 runes for audio state tracking
- All linting/type checks passing

### Sample Data
One talk loaded: `data/talks/2025-10-58-oaks/` with `eng` and `zhs` versions
Note: Alignment data not yet generated - text displays without word sync

## Next Steps (Phase 3 - Sync & Vocabulary)

1. **WhisperX script**: Generate alignment.json from audio+text files
2. **Vocabulary CRUD**: Backend endpoints + SQLite storage
3. **Text selection**: WordPopover component for saving vocabulary
4. **Vocabulary list page**: View and manage saved items

## Future Phases

- **Phase 4**: AI study helps (translation, register analysis)
- **Phase 5**: FSRS spaced repetition for review
- **Phase 6**: Sentence interleaving mode

## Key Files

### Backend
- `backend/src/gls/domain/models.py` - Core entities
- `backend/src/gls/domain/protocols.py` - Abstract interfaces for DI
- `backend/src/gls/api/deps.py` - FastAPI dependency injection
- `backend/src/gls/api/v1/playback.py` - Audio/alignment endpoints
- `backend/src/gls/infrastructure/storage/talk_storage.py` - File-based repos

### Frontend
- `frontend/src/lib/api/types.ts` - TypeScript API types
- `frontend/src/lib/api/client.ts` - Fetch wrapper with error handling
- `frontend/src/lib/api/talks.ts` - Talk/playback API methods
- `frontend/src/lib/stores/playback.svelte.ts` - Audio state with Svelte 5 runes
- `frontend/src/lib/components/audio/AudioPlayer.svelte` - Player with controls
- `frontend/src/lib/components/text/SyncedText.svelte` - Text with highlighting
- `frontend/src/routes/talks/[talkId]/+page.svelte` - Study view page

## Error Handling Pattern

Always handle failures gracefully with user feedback:
```typescript
// Frontend pattern
let error = $state<string | null>(null);
try {
  data = await api.fetch();
} catch (e) {
  error = e instanceof Error ? e.message : 'Operation failed';
}
```

```python
# Backend pattern - use HTTPException with clear messages
from fastapi import HTTPException
if not resource:
    raise HTTPException(status_code=404, detail="Resource not found")
```

## Notes

- PDF text extraction noise (timestamps, URLs, page numbers) is OK - LLM/WhisperX handles it
- Using `from __future__ import annotations` for Python 3.9 compatibility
- Frontend uses tabs for indentation (Prettier config)
